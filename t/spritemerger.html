<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spritesheet-Animator</title>
    <style>
        #fileInput {
            margin-bottom: 10px;
        }
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput" accept="image/*">
    <br>
    <label for="startFrame">Start Frame:</label>
    <input type="number" id="startFrame" min="0" value="0">
    <label for="endFrame">End Frame:</label>
    <input type="number" id="endFrame" min="0" value="0">
    <br>
    <label for="filePrefix">Dateipr√§fix:</label>
    <input type="text" id="filePrefix" value="sprite">
    <br>
    <label for="mergeRows">Zu mergenede Reihen (Index, durch Kommas getrennt):</label>
    <input type="text" id="mergeRows" value="">
    <br>
    <button id="exportFramesButton">Exportiere Frames</button>
    <br>
    <canvas id="spriteCanvas" width="44" height="44"></canvas>

    <script>
        const fileInput = document.getElementById('fileInput');
        const startFrameInput = document.getElementById('startFrame');
        const endFrameInput = document.getElementById('endFrame');
        const filePrefixInput = document.getElementById('filePrefix');
        const mergeRowsInput = document.getElementById('mergeRows');
        const exportFramesButton = document.getElementById('exportFramesButton');
        const canvas = document.getElementById('spriteCanvas');
        const ctx = canvas.getContext('2d');

        let spriteSheet = null;
        let currentFrame = 0;
        const frameWidth = 44;
        const frameHeight = 44;
        let animationSpeed = 100; // Milliseconds per frame

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const imageUrl = URL.createObjectURL(file);
                spriteSheet = new Image();
                spriteSheet.src = imageUrl;
                spriteSheet.onload = () => {
                    if (animationInterval) { clearInterval(animationInterval); }
                    animationSpeed = 100; // Reset to default speed when a new image is loaded
                    startAnimation();
                };
            }
        });

        var animationInterval;
        function startAnimation() {
            animationInterval = setInterval(() => {
                if (spriteSheet) {
                    drawFrame();
                    currentFrame = currentFrame + 1 > endFrame ? startFrame : (currentFrame + 1) % getNumberOfFrames();
                }
            }, animationSpeed);
        }

        function drawFrame() {
            const startFrame = parseInt(startFrameInput.value, 10);
            const endFrame = parseInt(endFrameInput.value, 10) || getNumberOfFrames() - 1;
            const mergeRows = mergeRowsInput.value.split(',').map(val => parseInt(val.trim(), 10)).filter(val => !isNaN(val));

            if (currentFrame < startFrame || currentFrame > endFrame) {
                currentFrame = (currentFrame + 1) % getNumberOfFrames();
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw all merged rows into the same frame
            mergeRows.forEach(direction => {
                ctx.drawImage(
                    spriteSheet,
                    currentFrame * frameWidth,
                    direction * frameHeight,
                    frameWidth,
                    frameHeight,
                    0,
                    0,
                    frameWidth,
                    frameHeight
                );
            });
        }

        function getNumberOfFrames() {
            if (spriteSheet) {
                return Math.floor(spriteSheet.width / frameWidth);
            }
            return 1;
        }

        exportFramesButton.addEventListener('click', () => {
            if (!spriteSheet) {
                alert('Bitte laden Sie zuerst ein Spritesheet hoch.');
                return;
            }

            const prefix = filePrefixInput.value;
            const numberOfFrames = getNumberOfFrames();
            const startFrame = parseInt(startFrameInput.value, 10);
            const endFrame = parseInt(endFrameInput.value, 10) || numberOfFrames - 1;
            const mergeRows = mergeRowsInput.value.split(',').map(val => parseInt(val.trim(), 10)).filter(val => !isNaN(val));

            for (let frame = 0; frame < numberOfFrames; frame++) {
                if (frame < startFrame || frame > endFrame) {
                    continue;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw all merged rows into the same frame
                mergeRows.forEach(direction => {
                    ctx.drawImage(
                        spriteSheet,
                        frame * frameWidth,
                        direction * frameHeight,
                        frameWidth,
                        frameHeight,
                        0,
                        0,
                        frameWidth,
                        frameHeight
                    );
                });

                const link = document.createElement('a');
                link.download = `${prefix}_merged_${frame}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        });
    </script>
</body>
</html>